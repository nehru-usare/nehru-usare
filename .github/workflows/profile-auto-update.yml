name: ğŸŒŒ Profile Auto Update

on:
  schedule:
    - cron: "0 0 * * *" # Every day at midnight UTC (~5:30 AM IST)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-profile:
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: ğŸ§± Checkout Repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Generate GitHub Contribution Snake
      - name: ğŸ Generate Contribution Snake
        uses: Platane/snk@v3
        with:
          github_user_name: nehru-usare
          outputs: |
            dist/github-contribution-grid-snake.svg
            dist/github-contribution-grid-snake-dark.svg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 3ï¸âƒ£ Push Snake to output branch
      - name: ğŸš€ Push Snake SVG
        uses: crazy-max/ghaction-github-pages@v3.1.0
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 4ï¸âƒ£ Update WakaTime (fixes image name)
      - name: ğŸ§® Update WakaTime Stats
        uses: anmol098/waka-readme-stats@master
        continue-on-error: true
        with:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SHOW_TITLE: "True"
          SHOW_TOTAL_CODE_TIME: "True"
          SHOW_PROFILE_VIEWS: "False"
          SHOW_LINES_OF_CODE: "True"
          SHOW_LANGUAGE: "True"
          SHOW_OS: "False"
          SHOW_EDITORS: "False"
          SHOW_PROJECTS: "False"
          SHOW_LOC_CHART: "False"
          SHOW_TIMEZONE: "Asia/Kolkata"

      # 5ï¸âƒ£ Optional â€” Add Recent GitHub Activity section
      - name: ğŸ•¹ï¸ Update Recent Activity
        uses: Readme-Workflows/recent-activity@v2
        with:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MAX_LINES: 5
          COMMIT_MSG: "ğŸ§¾ Update recent activity in README"
        continue-on-error: true

      # 6ï¸âƒ£ Refresh GitHub Stats Cache
      - name: ğŸ”„ Refresh GitHub Stats Cache
        run: |
          echo "Refreshing GitHub Stats..."
          curl -s -X PURGE "https://github-readme-stats.vercel.app/api?username=nehru-usare" > /dev/null
          curl -s -X PURGE "https://github-readme-activity-graph.vercel.app/graph?username=nehru-usare" > /dev/null
        continue-on-error: true

      # 7ï¸âƒ£ Commit updated profile files
      - name: âœï¸ Commit and Push Changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions Bot"
          git add .
          git commit -m "ğŸ”„ Auto-update profile (README + Snake + Stats)" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/nehru-usare/nehru-usare.git HEAD:main
